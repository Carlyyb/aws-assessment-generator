# 自定义学习目标功能实现报告

## 功能概述

实现了自定义学习目标功能，允许用户通过手动输入学习目标来生成测试，使上传讲义文件变为可选。

## 实现的功能

### 1. 上传讲义文件 vs 课程知识库文件的影响差异

**上传讲义文件的作用：**
- 直接用于生成当前测试的主题提取 (`getTopicsPrompt`)
- 作为 `ReferenceDocuments` 的内容，直接影响题目生成
- 这些文件内容会被完整传递给AI模型进行主题提取和初始题目生成

**课程知识库文件的作用：**
- 用于RAG检索，在题目改进阶段提供相关背景信息
- 通过 `getRelevantDocuments` 和 `improveQuestions` 流程使用
- 提供更广泛的课程背景知识来增强题目质量

### 2. 自定义学习目标功能

**新增功能：**
- ✅ 添加自定义学习目标输入框（可选）
- ✅ 自定义prompt直接影响题目生成（类似getTopic作用）
- ✅ 使讲义文件上传变为可选
- ✅ 验证逻辑：至少需要文件或自定义学习目标之一

## 代码修改详情

### 后端修改

1. **schema.graphql**
   - 在 `GenerateAssessmentInput` 中添加 `customPrompt: String` 字段

2. **prompts.ts**
   - 修改 `getTopicsPrompt` 函数，添加 `customPrompt` 参数
   - 当有自定义prompt时，优先使用自定义prompt作为主题提取
   - 文档内容作为补充信息

3. **genAiService.ts**
   - 修改 `getTopics` 方法，添加 `customPrompt` 参数支持

4. **referenceDocuments.ts**
   - 修改验证逻辑，允许空文档列表
   - 要求至少有文档或自定义prompt之一

5. **index.ts**
   - 传递 `customPrompt` 参数到 `getTopics` 方法
   - 更新日志信息显示自定义prompt使用状态

### 前端修改

1. **API.ts**
   - 更新 `GenerateAssessmentInput` 类型定义，添加 `customPrompt` 字段

2. **GenerateAssessments.tsx**
   - 添加自定义学习目标状态管理
   - 新增自定义学习目标输入框（Textarea）
   - 修改验证逻辑：至少需要文件或自定义学习目标之一
   - 修改文件上传逻辑，仅在有文件时上传
   - 更新UI文案，根据是否有自定义prompt动态显示
   - 在GraphQL调用中传递 `customPrompt` 参数

## 用户体验改进

1. **智能提示**
   - 文件上传区域根据是否有自定义prompt显示不同描述
   - 验证错误消息提供明确的操作指导

2. **灵活的工作流程**
   - 用户可以只上传文件（传统模式）
   - 用户可以只输入自定义学习目标（新模式）
   - 用户可以同时使用两者（增强模式）

3. **调试信息**
   - 生成过程中显示是否使用了自定义学习目标
   - 错误诊断信息包含自定义prompt状态

## 测试建议

1. **只使用自定义学习目标**
   - 输入学习目标，不上传文件，测试生成功能

2. **只使用上传文件**
   - 不输入学习目标，只上传文件，测试传统功能

3. **同时使用两者**
   - 输入学习目标并上传文件，测试增强模式

4. **验证逻辑测试**
   - 两者都不提供，确认显示错误提示

## 技术要点

- 自定义prompt具有最高优先级，作为主要的学习目标来源
- 上传的文档作为补充context，为AI提供更多背景信息
- 保持向后兼容性，现有的文件上传流程不受影响
- 优化了prompt处理逻辑，减少token使用量
