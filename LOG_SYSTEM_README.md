# Assessment Generator 日志系统

## 概述

这是一个为Assessment Generator应用设计的中央化日志管理系统，提供实时的系统监控、错误追踪和性能分析功能。

## 功能特性

### 1. 日志聚合
- **自动收集**: 自动从所有Lambda函数收集结构化日志
- **实时处理**: 通过CloudWatch Logs订阅实现实时日志处理
- **智能解析**: 支持JSON格式和文本格式日志的智能解析
- **数据存储**: 将处理后的日志存储在DynamoDB中，支持快速查询

### 2. 系统监控
- **健康状态**: 实时监控系统整体健康状况
- **性能指标**: 跟踪Lambda函数执行时间、内存使用等
- **错误统计**: 自动统计和分类错误类型
- **服务状态**: 监控各个微服务的运行状态

### 3. 管理员界面
- **仪表盘**: 系统健康状态概览
- **日志查看**: 支持多维度日志查询和过滤
- **实时刷新**: 支持实时数据更新
- **导出功能**: 支持日志数据导出（计划中）

### 4. 告警系统
- **阈值告警**: 基于预定义规则的自动告警
- **多渠道通知**: 支持邮件、SNS等多种通知方式
- **告警历史**: 完整的告警历史记录

## 架构组件

### Backend组件
1. **LoggingStack**: 日志系统的主要CDK Stack
2. **LogAggregator Lambda**: 日志聚合和处理函数
3. **LogQuery Lambda**: 为前端提供日志查询API
4. **ErrorAlert Lambda**: 错误告警处理函数
5. **DynamoDB表**: 存储日志数据和系统指标

### Frontend组件
1. **LogManagement页面**: 管理员日志管理界面
2. **GraphQL集成**: 通过GraphQL API查询日志数据

## 部署指南

### 1. 更新CDK代码
系统已经集成到现有的CDK stack中，部署时会自动创建所有必要的资源。

### 2. 权限配置
系统需要以下权限：
- CloudWatch Logs读取权限
- DynamoDB读写权限
- Lambda执行权限

### 3. 环境变量
确保以下环境变量正确配置：
```
LOG_ANALYTICS_TABLE: 日志分析表名
SYSTEM_METRICS_TABLE: 系统指标表名
POWERTOOLS_SERVICE_NAME: 服务名称
```

## 使用指南

### 1. 访问日志管理界面
1. 以管理员身份登录系统
2. 导航到 "设置" -> "日志管理"
3. 查看系统概览或具体日志记录

### 2. 日志查询
- **时间范围**: 支持1小时、24小时、7天、30天的时间筛选
- **服务筛选**: 按特定服务筛选日志
- **级别筛选**: 按ERROR、WARN、INFO、DEBUG级别筛选
- **文本搜索**: 在日志消息中搜索特定关键词

### 3. 系统监控
- **健康指标**: 查看总请求数、错误率、平均响应时间
- **服务状态**: 监控各服务的健康状况
- **热门错误**: 查看最常见的错误类型

## 告警配置

当前默认的告警规则：
- 错误数量 > 10次/5分钟
- Lambda执行时间 > 30秒
- 内存使用 > 400MB

## 性能优化

### 1. 数据保留
- 日志数据默认保留30天
- 系统指标默认保留90天
- 通过TTL自动清理过期数据

### 2. 查询优化
- 使用GSI(全局二级索引)优化查询性能
- 按时间分区存储数据
- 实现数据预聚合

### 3. 成本控制
- 自动数据过期机制
- 按需扩缩容
- 优化Lambda内存配置

## 故障排除

### 常见问题
1. **日志未显示**: 检查CloudWatch Logs订阅配置
2. **查询慢**: 确保使用了正确的GSI查询
3. **告警不工作**: 检查DynamoDB Stream配置

### 调试命令
```bash
# 查看Lambda函数日志
aws logs describe-log-groups --log-group-name-prefix "/aws/lambda/gen-assess"

# 检查DynamoDB表状态
aws dynamodb describe-table --table-name LogAnalyticsTable
```

## 未来扩展

### 计划功能
1. **ElasticSearch集成**: 更强大的全文搜索
2. **自定义仪表盘**: 用户自定义监控面板
3. **机器学习告警**: 基于ML的异常检测
4. **数据可视化**: 更丰富的图表和趋势分析

### 性能增强
1. **流式处理**: 使用Kinesis Data Streams
2. **批处理优化**: Lambda批处理模式
3. **缓存策略**: Redis缓存热点数据

## 维护指南

### 定期维护
1. 监控DynamoDB使用量
2. 检查Lambda函数性能
3. 更新告警阈值
4. 备份重要配置

### 扩容策略
- DynamoDB按需计费模式
- Lambda并发限制调整
- CloudWatch Logs保留期调整

## 联系支持

如有问题或建议，请联系系统管理员或提交Issue到项目仓库。

---

**注意**: 这是一个企业级日志系统，包含敏感的系统信息。请确保只有授权用户才能访问日志管理功能。
